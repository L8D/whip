<!DOCTYPE html>

<html>
<head>
  <title>Whip interpreter</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="bin.html">
                bin.js
              </a>
            
              
              <a class="source" href="corelib.html">
                corelib.coffee
              </a>
            
              
              <a class="source" href="stdlib.html">
                stdlib.coffee
              </a>
            
              
              <a class="source" href="syn.html">
                syn.coffee
              </a>
            
              
              <a class="source" href="whip.html">
                whip.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1>Whip interpreter</h1>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>library = require <span class="string">'./stdlib'</span>
special = require <span class="string">'./corelib'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h3>Context class</h3>
<p>The <code>Context</code> class is used for maintaining context&#39;s and scopes
of defined variables.</p>
<p>It&#39;s constructor takes two args, and binds them to the scope
and parent attributes. The scope should be an object with keys
representing variable names, the parent should be another instance
of a <code>Context</code> to maintain scopes. The parent though isn&#39;t required
to properly create and use the <code>Context</code> class.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="class"><span class="keyword">class</span> <span class="title">Context</span></span>
  constructor: (<span class="property">@scope</span>, <span class="property">@parent</span>) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h4>Get</h4>
<p>Takes an identifier string and returns the value from the scope.
However if it can&#39;t find that value, it attempts to call <code>get</code> on
the parent context and return that result.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  get: (ident) -&gt;
    <span class="keyword">if</span> ident <span class="keyword">of</span> <span class="property">@scope</span>
      <span class="property">@scope</span>[ident]
    <span class="keyword">else</span> <span class="keyword">if</span> <span class="property">@parent</span> <span class="keyword">isnt</span> <span class="literal">undefined</span>
      <span class="property">@parent</span>.get ident</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h4>Set</h4>
<p>Takes and identifier and value.
If there is no parent context, it maps the value to the identifier
in the scope. If there is a parent, it calls <code>set</code> on that instead.</p>
<p>This method is only used by the core library function <code>def</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  set: (ident, value) -&gt;
    <span class="keyword">if</span> <span class="property">@parnet</span> <span class="keyword">is</span> <span class="literal">undefined</span>
      <span class="property">@scope</span>[ident] = value
    <span class="keyword">else</span>
      <span class="property">@parent</span>.set ident, value</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h3>Var class</h3>
<p>This class is simply used to better keep track of variables
and for the future if we need to easily edit stuff.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="class"><span class="keyword">class</span> <span class="title">Var</span></span>
  constructor: (<span class="property">@type</span>, <span class="property">@value</span>) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h2>Tokenize</h2>
<p>The <code>tokenize</code> function takes input and returns an array
of tokens representing each instruction part.</p>
<p>It also attempts to add surrounding parens if it detects that there
are multiple forms in the global scope.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">tokenize</span></span> = (input) -&gt;
  o = input
    .replace(<span class="regexp">/\\"/g</span>, <span class="string">"!dquote!"</span>)
    .replace(<span class="regexp">/\s+' '\s+/g</span>, <span class="string">"'!space!'"</span>)
    .split(<span class="regexp">/"/</span>)
    .map((x, i) -&gt;
      <span class="keyword">if</span> i % <span class="number">2</span> <span class="keyword">is</span> <span class="number">0</span> <span class="comment"># not in string</span>
        x
          .replace(<span class="regexp">/;.*(\n|\z)/</span>, <span class="string">''</span>) <span class="comment"># comment</span>
          .replace(<span class="regexp">/\(/g</span>, <span class="string">' ( '</span>)
          .replace(<span class="regexp">/\)/g</span>, <span class="string">' ) '</span>)
          .replace(<span class="regexp">/\{/g</span>, <span class="string">' { '</span>)
          .replace(<span class="regexp">/\}/g</span>, <span class="string">' } '</span>)
          .replace(<span class="regexp">/:/g</span>, <span class="string">' : '</span>)
      <span class="keyword">else</span>
        x.replace <span class="regexp">/\s/g</span>, <span class="string">"!space!"</span>
    )
    .join(<span class="string">'"'</span>)
    .trim()
    .split(<span class="regexp">/\s+/</span>)
    .map (x) -&gt; x
      .replace(<span class="regexp">/!space!/g</span>, <span class="string">" "</span>)
      .replace(<span class="regexp">/!dquote!/g</span>, <span class="string">'\\"'</span>)
      .replace(<span class="regexp">/!squote!/g</span>, <span class="string">"\\'"</span>)
  i = <span class="number">1</span>
  <span class="keyword">for</span> t <span class="keyword">in</span> o[<span class="number">1.</span>.]
    <span class="keyword">switch</span> t
      <span class="keyword">when</span> <span class="string">'('</span>
        i++
        <span class="keyword">if</span> i <span class="keyword">is</span> <span class="number">1</span>
          o.unshift <span class="string">'('</span>
          o.push <span class="string">')'</span>
          <span class="keyword">break</span>
      <span class="keyword">when</span> <span class="string">')'</span> <span class="keyword">then</span> i--
  o</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h2>Objectize</h2>
<p>Returns an object deciphered from output of <code>tokenize</code>.</p>
<p>Whip&#39;s dicitonary syntax is <code>key</code>, <code>:</code>, <code>value</code> and then
whitespace between each definition.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">objectize</span></span> = (input, object = {}, key = <span class="literal">true</span>) -&gt;
  token = input.shift()
  <span class="keyword">if</span> token <span class="keyword">is</span> <span class="string">'}'</span>
    categorize object
  <span class="keyword">else</span> <span class="keyword">if</span> token <span class="keyword">is</span> <span class="string">':'</span>
    objectize input, object, <span class="literal">false</span>
  <span class="keyword">else</span> <span class="keyword">if</span> key
    object[categorize(token).value] = objectize input, object
    objectize input, object, <span class="literal">true</span>
  <span class="keyword">else</span>
    <span class="keyword">if</span> token <span class="keyword">is</span> <span class="string">'('</span>
      parenthesize token
    <span class="keyword">else</span>
      categorize token</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <h2>Parenthesize</h2>
<p>Returns an array deciphered from output of <code>tokenize</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">parenthesize</span></span> = (input, list = []) -&gt;
  token = input.shift()
  <span class="keyword">switch</span> token
    <span class="keyword">when</span> <span class="literal">undefined</span>
      list.pop()
    <span class="keyword">when</span> <span class="string">'('</span>
      list.push parenthesize input
      parenthesize input, list
    <span class="keyword">when</span> <span class="string">')'</span>
      list
    <span class="keyword">when</span> <span class="string">'{'</span>
      list.push objectize input
      parenthesize input, list
    <span class="keyword">else</span>
      parenthesize input, list.concat categorize token</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h2>Categorize</h2>
<p>Returns <code>Var</code> instance from output of <code>tokenize</code>.
Primarily used by <code>parenthesize</code> and <code>objectize</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">categorize</span></span> = (input) -&gt;
  <span class="keyword">if</span> <span class="keyword">not</span> isNaN parseFloat input
    <span class="keyword">new</span> Var <span class="string">'literal'</span>, parseFloat input
  <span class="keyword">else</span> <span class="keyword">if</span> input[<span class="number">0</span>] <span class="keyword">is</span> <span class="string">'"'</span> <span class="keyword">and</span> input[-<span class="number">1.</span>.] <span class="keyword">is</span> <span class="string">'"'</span>
    <span class="keyword">new</span> Var <span class="string">'literal'</span>, eval input
  <span class="keyword">else</span> <span class="keyword">if</span> input[<span class="number">0</span>] <span class="keyword">is</span> <span class="string">"'"</span> <span class="keyword">and</span> input[-<span class="number">1.</span>.] <span class="keyword">is</span> <span class="string">"'"</span>
    <span class="keyword">new</span> Var <span class="string">'literal'</span>, input[<span class="number">1.</span>.-<span class="number">2</span>]
  <span class="keyword">else</span> <span class="keyword">if</span> input <span class="keyword">instanceof</span> Object
    <span class="keyword">new</span> Var <span class="string">'dict'</span>, input
  <span class="keyword">else</span>
    <span class="keyword">new</span> Var <span class="string">'identifier'</span>, input</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h2>Parse</h2>
<p>Wrapper for returned parsed output of input.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">parse</span></span> = (input) -&gt;
  parenthesize tokenize input

<span class="function"><span class="title">object_mapper</span></span> = (obj, fn) -&gt; fn v <span class="keyword">for</span> v <span class="keyword">in</span> Object.getOwnPropertyNames obj</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <h2>Interpret</h2>
<p>Returns value based on parsed information.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">interpret</span></span> = (input, <span class="function"><span class="title">context</span></span>=(<span class="keyword">new</span> Context library)) -&gt;
  <span class="keyword">if</span> input <span class="keyword">instanceof</span> Array
    interpret_list input, context
  <span class="keyword">else</span> <span class="keyword">if</span> input.type <span class="keyword">is</span> <span class="string">'identifier'</span>
    context.get input.value
  <span class="keyword">else</span> <span class="keyword">if</span> input.type <span class="keyword">is</span> <span class="string">'dict'</span>
    object_mapper input.value, (x) -&gt; input.value[x] = interpret input.value[x]
    input.value
  <span class="keyword">else</span>
    input.value</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <h2>Interpret List</h2>
<p>I&#39;m tired...</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">interpret_list</span></span> = (input, context) -&gt;
  <span class="keyword">return</span> <span class="keyword">if</span> input.length <span class="keyword">is</span> <span class="number">0</span>
  <span class="keyword">if</span> input[<span class="number">0</span>].value <span class="keyword">of</span> special
    special[input[<span class="number">0</span>].value](input, context)
  <span class="keyword">else</span>
    list = input.map (x) -&gt; interpret(x, context)
    <span class="keyword">if</span> list[<span class="number">0</span>] <span class="keyword">instanceof</span> Function
      list[<span class="number">0</span>] list[<span class="number">1.</span>.]
    <span class="keyword">else</span>
      list

exports.interpret = interpret
exports.parse = parse
exports.tokenize = tokenize
exports.Context = Context
exports.Var = Var</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
